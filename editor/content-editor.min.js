var editor={init:!1,active:!1,selectedText:{},editableLength:0,editBtns:["editor-btn-start","editor-btn-save","editor-btn-exit"],on:function(){return"/"==window.location.pathname&&"9000"==window.location.port?!0:!1},socket:function(){return socket=io.connect("http://localhost:9000")},edit:function(a){editor.init?editor.activate(a):($("<link/>",{rel:"stylesheet",type:"text/css",href:"editor/content-editor.css"}).appendTo("head"),$.getScript("socket.io/socket.io.js").done(function(b,c){editor.activate(a)}).fail(function(b,
a,d){editor.popupMessage("error","SCRIPT ERROR","Triggered ajaxError handler.",2500)}))},activate:function(a){editor.on()&&(editor.selectedText&&(editor.selectedText={}),editor.init&&editor.resetEditor(),!$("[contenteditable]").length&&$("#editor-btn-start").length?$(".editor-btn-ignition").hide():($("#editor-htmlContent").length||(editor.createEditorObj("body","editor"),editor.createEditorObj("#editor","editor-htmlContent").hide()),$("#editor-htmlContent").empty().load(a,function(b,a,d){"success"==
a&&(editor.editableLength=$("[contenteditable]").length,editor.markText(),editor.init||(editor.manualEditor(),editor.init=!0))})))},selector:{savedSelection:{},selection:{},$editingObj:{},selectionFor:function(a,b){a.length&&(b?editor.selector.getSelectionObject(a,b):editor.isObjEmpty(editor.selectedText)&&editor.selector.getSelectionObject(a))},getSelectionObject:function(a,b){a.mousedown(function(){window.getSelection().removeAllRanges()});a.mouseup(function(){if(editor.active){var a=editor,d;d=
window.getSelection?{selectedObj:window.getSelection(),selectedString:window.getSelection().toString()}:void 0;a.selectedText=d;editor.selectedText.editableString=$(this).html();editor.selectedText.editableObj=$(this);editor.selector.savedSelection=editor.selector.saveSelection();editor.selector.$editingObj=$(editor.selector.saveSelection()[0].startContainer.parentNode);editor.selectedText.selectedString?b?editor.selector.determineSelection($("img",".editor-tool:not('.editor-link-tool')")):editor.selector.determineSelection($("img",
".editor-tool")):editor.changeBtnsState($("img",".editor-tool"),"orig",!1)}})},determineSelection:function(a){editor.changeBtnsState(a,"orig",!1);for(var b=0;b<editor.selector.$editingObj.contents().length;b++){var c=editor.selector.$editingObj.contents()[b],d=editor.selector.$editingObj.contents().context.localName,f=editor.selector.$editingObj.contents().context.innerText;if(-1!=c.textContent.indexOf(editor.selectedText.selectedString)){"b"===d||"i"===d||"u"===d?f===editor.selectedText.selectedString&&
editor.changeBtnsState(a,"active",!0):"a"===d?f===editor.selectedText.selectedString&&editor.changeBtnsState($("img",a.parent("[data-editor-tag='a']")),"active",!0):editor.changeBtnsState(a,"active",!0);break}}},saveSelection:function(){if(window.getSelection&&(editor.selector.selection=window.getSelection(),editor.selector.selection.getRangeAt&&editor.selector.selection.rangeCount)){for(var a=[],b=0,c=editor.selector.selection.rangeCount;b<c;++b)a.push(editor.selector.selection.getRangeAt(b));return a}return null},
restoreSelection:function(a){if(a&&window.getSelection){editor.selector.selection=window.getSelection();editor.selector.selection.removeAllRanges();for(var b=0,c=a.length;b<c;++b)editor.selector.selection.addRange(a[b])}}},makeEditable:function(a){$("[contenteditable]").each(function(){a?("click"==$(this).data("editable")?$(this).hasClass("editor-tolltip-on")||($(this).addClass("editor-tolltip-on"),editor.attachTooltip($(this))):$(this).attr("contenteditable","true"),editor.active=!0):($(this).attr("contenteditable",
"false"),editor.active=!1)})},resetEditor:function(a){editor.makeEditable(!1);a||$("#editor-btn-start").fadeIn();$("#editor-btn-save, #editor-btn-exit, #editor-toolbox").fadeOut();editor.clearTooltips();editor.changeBtnsState($("img",".editor-tool"),"orig",!1)},markText:function(){var a=0;$("[contenteditable]").each(function(b){b>editor.editableLength/2-1?($(this).data("edit",a+1),a++):$(this).data("edit",b+1)})},manualEditor:function(){function a(){var b=!1;$("[contenteditable]").each(function(a){if(a>
editor.editableLength/2-1)return b?editor.socket().emit("htmlData",$("#editor-htmlContent").html(),editor.settings.path,editor.settings.src):editor.popupMessage("","STATUS","No content has been changed.",2500),!1;$(this).html()!==$("#editor-htmlContent [contenteditable]").eq($(this).data("edit")-1).html()&&(b=!0,$("#editor-htmlContent [contenteditable]").eq($(this).data("edit")-1).html($(this).html()))})}$("[contenteditable]").length&&!$("#editor-btn-start").length?editor.createObjects("#editor",
editor.editBtns,"editor-btn-ignition"):$("#editor-btn-start").show();$(".editor-btn-ignition").click(function(){if("editor-btn-start"==$(this).attr("id"))editor.makeEditable(!0),editor.selector.selectionFor($("[contenteditable]:not([data-editable])")),$(this).fadeOut(),$("#editor-btn-save, #editor-btn-exit, #editor-toolbox").fadeIn();else if(editor.resetEditor(),"editor-btn-save"==$(this).attr("id")){var b=""==editor.settings.path?editor.settings.src:editor.settings.path+"/"+editor.settings.src;$("#editor-htmlContent").empty().load(b,
function(b,d,f){"success"==d&&(editor.markText(),a())})}});editor.createToolbox();editor.socket().on("savingStatus",function(b,a){"SUCCESS"==b?editor.popupMessage(b.toLowerCase(),b,a,3E3):editor.popupMessage(b.toLowerCase(),b,JSON.stringify(a),3E3)});editor.activateKey($(document),69,function(){"none"==$("#editor-btn-start").css("display")&&"none"==$("#editor-btn-save, #editor-btn-exit").css("display")?$("#editor-btn-start").show():($(".editor-btn-ignition, #editor-toolbox").hide(),editor.resetEditor(!0),
window.getSelection().removeAllRanges())});$("[contenteditable]").on("paste",function(a){a.preventDefault();a=(a.originalEvent||a).clipboardData.getData("text/plain")||prompt("Paste something..");window.document.execCommand("insertText",!1,a)})},createToolbox:function(){editor.createEditorObj("#editor","editor-toolbox").load("editor/tool-box.html",function(){function a(){c.off("focusout");f.remove();editor.selector.$editingObj.show();b();editor.changeBtnsState($("img",".editor-tool"),"active",!0);
editor.selector.restoreSelection(editor.selector.savedSelection)}function b(){function a(){d.removeClass("active").find("input").val("")}editor.isGS()?(TweenMax.to($("#editor-add-link, #editor-hide-link"),.3,{width:0,opacity:0,clearProps:"all"}),TweenMax.to(c,.3,{width:0,opacity:0,clearProps:"all",onComplete:a})):($("#editor-add-link, #editor-hide-link, #editor-link-input input").css({width:0}).attr("style",""),a())}$.ui&&$(this).draggable({handle:"#editor-toolbox-handle"},{cursor:"move"},{containment:"body"});
var c=$("#editor-link-input input"),d=$("#editor-link-input"),f="",l=$("#editor-add-link");$(".editor-tool").mousedown(function(b){$target=$(b.target).parent();if(!$target.hasClass("activated"))return!1;if("createLink"==$target.data("editor_action")){editor.changeBtnsState($("img",".editor-tool"),"orig",!1);d.addClass("active");var g=editor.selector.savedSelection[0].startContainer.textContent;b=[];for(var e=0;e<editor.selector.$editingObj.contents().length;e++){var k=editor.selector.$editingObj.contents()[e],
h="";k.textContent==g?(h=k.textContent,h=h.insert(editor.selector.savedSelection[0].endOffset,"</span>"),h=h.insert(editor.selector.savedSelection[0].startOffset,"<span id='editor-selection'>"),b.push(h)):b.push(k)}g="";for(e=0;e<b.length;e++)g=b[e].data?g+b[e].data:b[e].outerHTML?g+b[e].outerHTML:g+b[e];editor.selector.$editingObj.hide().clone(!0,!0).addClass("editor-obj-duplicate").insertAfter(editor.selector.$editingObj).show();f=$(".editor-obj-duplicate");f.html(g);setTimeout(function(){c.focus();
c.on("focusout",function(){a()})},0);editor.isGS()?TweenMax.fromTo(c,.2,{width:0},{width:165}):c.css({width:165})}else"unlink"==$target.data("editor_action")&&(editor.changeBtnsState($("img",".editor-tool"),"orig",!1),window.getSelection().removeAllRanges()),document.execCommand($target.data("editor_action"),!1,!0)});l.click(function(){var a=$(this).siblings("#editor-link-input input").val();if(editor.isURL(a))f.remove(),editor.selector.$editingObj.show(),editor.selector.restoreSelection(editor.selector.savedSelection),
document.execCommand($(this).data("editor_action"),!1,$(this).siblings("#editor-link-input input").val()),editor.selectedText.editableObj.find("a").each(function(){$(this).attr("target")||$(this).attr("target","_blanc")});else return""==a?editor.popupMessage("error","URL EMPTY","Please insert URL.",2500):editor.popupMessage("error","URL ERROR","Not a valid URL format.<br/>Try again.",2500),c.focus(),!1;b();editor.changeBtnsState($("img",".editor-tool:not('.editor-link-tool[data-editor-tag]')"),"orig",
!1)});editor.activateKey(c,13,function(){c.blur();l.focus().click()});$("#editor-hide-link").click(function(){a()})})},changeBtnsState:function(a,b,c){a.each(function(){$(this).attr("src",$(this).data(b));c?$(this).parent().addClass("activated"):$(this).parent().removeClass("activated")})},attachTooltip:function(a){a.hover(function(){if(editor.active){var a=$(this),c=a.data("edit"),d=!1;$tooltip=$(".editor-tooltip");$tooltip.length&&$tooltip.each(function(){if($(this).data("obj")==c)return d=!0,!1});
d||($(this).parent().css("position","relative"),$("<div></div>").appendTo($(this).parent()).addClass("editor-tooltip editor-tooltip"+c).data("obj",c).html($(this).text()).show().css({marginLeft:-$(this).parent().outerWidth()/2,top:-a.outerHeight(),maxWidth:$(this).parent().outerWidth()}).attr("contenteditable",!0).append("<div class='editor-tooltip-exit' contenteditable='false'></div>"),$("<div></div>").appendTo(".editor-tooltip"+c).addClass("editor-tooltip-arrow editor-tooltip-arrow"+c).show().css({left:$(".editor-tooltip"+
c).outerWidth()/2-$(".editor-tooltip-arrow").outerWidth()/2,top:$(".editor-tooltip"+c).outerHeight()}),editor.isGS()?TweenMax.from($(".editor-tooltip"+c),.5,{y:50,scale:0,opacity:0}):$(".editor-tooltip"+c).show(),editor.selector.selectionFor($(".editor-tooltip"+c),a.data("editable")),editor.detectChange($(".editor-tooltip"+c+"[contenteditable]")),$(".editor-tooltip-exit").click(function(a){a.stopPropagation();$(".editor-tooltip-arrow"+$(this).parent().data("obj")).remove();$(this).parent().remove()}))}})},
clearTooltips:function(){$(".editor-tooltip, .editor-tooltip-arrow").remove();$(".editor-tolltip-on").removeClass("editor-tolltip-on")},detectChange:function(a){var b="",c="";a.on("click",function(a){a.stopPropagation()});a.on("focus",function(){b=$(this).html()}).on("blur keyup paste",function(){b==$(this).html()&&b.substring(0,c.length)==c||$(this).trigger("change")});a.on("change",function(){b=$(this).html();$(this).data("obj")&&(c=$(this).html().substring(0,$(this).html().indexOf('<div class="editor-tooltip-exit" contenteditable="false">')),
$(this).data("obj")==$("[contenteditable]:data('edit')").eq($(this).data("obj")-1).data("edit")&&$("[contenteditable]:data('edit')").eq($(this).data("obj")-1).html(c))})},activateKey:function(a,b,c){a.keypress(function(a){a.which==b&&c()})},popupMessage:function(a,b,c,d){$("#editor-message").length||editor.createEditorObj("#editor","editor-message");$("#editor-message").addClass(a).text(b).append("<p>"+c+"</p>").fadeIn().delay(d).fadeOut()},createEditorObj:function(a,b,c){$("<div></div>").appendTo(a).attr("id",
b).addClass(c);return $("#"+b)},createObjects:function(a,b,c){for(var d=0;d<b.length;d++)editor.createEditorObj(a,b[d],c)},isObjEmpty:function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},isURL:function(a){var b=RegExp("^(?!mailto:)(?:(?:http|https|ftp)://)(?:\\S+(?::\\S*)?@)?(?:(?:(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[0-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z\\u00a1-\\uffff0-9]+-?)*[a-z\\u00a1-\\uffff0-9]+)(?:\\.(?:[a-z\\u00a1-\\uffff0-9]+-?)*[a-z\\u00a1-\\uffff0-9]+)*(?:\\.(?:[a-z\\u00a1-\\uffff]{2,})))|localhost)(?::\\d{2,5})?(?:(/|\\?|#)[^\\s]*)?$",
"i");return 2083>a.length&&b.test(a)},isGS:function(){if(TweenMax||TweenLite)return!0}};String.prototype.insert=function(a,b){return 0<a?this.substring(0,a)+b+this.substring(a,this.length):b+this};