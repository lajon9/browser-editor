/**
Browser Editor v1.0, Plugin that allows editing html file in the browser.
Copyright (C) 2015,  Marcin Banaszak, http://www.marcinbanaszak.com,
https://github.com/lajon9/browser-editor

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish copies of the Software, and to permit 
persons to whom the Software is furnished to do so, subject to the following 
conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
IN NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR
OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
OTHER DEALINGS IN THE SOFTWARE.
**/
var E={init:!1,active:!1,wasHereActivated:function(){return $("#editor").hasClass("launched")?!0:!1},selectedText:{},editableLength:0,excludeObj:[],username:localStorage&&localStorage.getItem("editor-username")?localStorage.getItem("editor-username"):"",date:(new Date).toLocaleString().slice(0,10),editBtns:["editor-btn-start","editor-btn-save","editor-btn-exit"],imagesObjects:["editor-images-handle","editor-images-desc","editor-images-wrapper"],googleDiff:"",on:function(){return"/"==window.location.pathname&&
"9000"==window.location.port?!0:!1},socket:function(){return socket=io.connect("http://localhost:9000")},log:{location:"editor/editor-log.html",init:function(){E.socket().emit("logUser",E.username+" - "+E.date,this.location,"init")},change:function(a){E.socket().emit("logData",a,this.location)}},edit:function(a){E.on()&&(E.init?E.activate.init(a):($("<link/>",{rel:"stylesheet",type:"text/css",href:"editor/content-editor.css"}).appendTo("head"),$.getScript("editor/diff_match_patch.js").done(function(a,
b){E.googleDiffExtend.prittierHTML();E.googleDiff=new diff_match_patch}).fail(function(a,b,d){}),$.getScript("socket.io/socket.io.js").done(function(c,b){E.createEditorObj("div")("body","editor");localStorage&&localStorage.getItem("editor-username")?(E.log.init(),E.activate.init(a)):E.activate.login(a)}).fail(function(a,b,d){E.popupMessage("error","SCRIPT ERROR","Triggered ajaxError handler. Please try to reload the application.",2500)})))},activate:{login:function(a){E.popupMessage("editor-login",
"LOGIN","Type Your Name");var c=E.createEditorObj("input")("#editor-message","editor-login-input","");E.createEditorObj("div")("#editor-message","editor-login-submit","editor-login-btn").click(function(){c.val()&&($("#editor-message").fadeOut(),E.username=c.val(),localStorage.setItem("editor-username",E.username),E.log.init(),E.activate.init(a))})},init:function(a){E.selectedText&&(E.selectedText={});E.init&&E.resetEditor.defaultFunc();!$("[contenteditable]").length&&$("#editor-btn-start").length?
$(".editor-btn-ignition").hide():($("#editor-htmlContent").length||E.createEditorObj("div")("#editor","editor-htmlContent").hide(),$("#editor-htmlContent").empty().load(a,function(a,b,d){"success"==b&&($("#editor").removeClass("launched"),E.editableLength=$(E.currentEditableObj().selectedOnly).length,E.markText(),E.init||(E.manualEditor.init(),E.init=!0),E.extend(E.activate.services))}))},services:[]},selector:{savedSelection:{},selection:{},$editingObj:{},selectionFor:function(a,c){a.length&&(c?
E.selector.getSelectionObject(a,c):E.isObjEmpty(E.selectedText)&&E.selector.getSelectionObject(a))},getSelectionObject:function(a,c){a.mousedown(function(){window.getSelection().removeAllRanges()});a.mouseup(function(){if(E.active){var a=E,d;d=window.getSelection?{selectedObj:window.getSelection(),selectedString:window.getSelection().toString()}:void 0;a.selectedText=d;E.selectedText.editableString=$(this).html();E.selectedText.editableObj=$(this);E.selector.savedSelection=E.selector.saveSelection();
E.selector.$editingObj=$(E.selector.saveSelection()[0].startContainer.parentNode);E.selectedText.selectedString?c?E.selector.determineSelection($("img",".editor-tool:not('.editor-link-tool')")):E.selector.determineSelection($("img",".editor-tool")):E.changeBtnsState($("img",".editor-tool"),"orig",!1)}})},determineSelection:function(a){E.changeBtnsState(a,"orig",!1);for(var c=0;c<E.selector.$editingObj.contents().length;c++){var b=E.selector.$editingObj.contents()[c],d=E.selector.$editingObj.contents().context.localName,
e=E.selector.$editingObj.contents().context.innerText;if(-1!=b.textContent.indexOf(E.selectedText.selectedString)){"b"===d||"i"===d||"u"===d?e===E.selectedText.selectedString&&E.changeBtnsState(a,"active",!0):"a"===d?e===E.selectedText.selectedString&&E.changeBtnsState($("img",a.parent("[data-editor-tag='a']")),"active",!0):E.changeBtnsState(a,"active",!0);break}}},saveSelection:function(){if(window.getSelection&&(E.selector.selection=window.getSelection(),E.selector.selection.getRangeAt&&E.selector.selection.rangeCount)){for(var a=
[],c=0,b=E.selector.selection.rangeCount;c<b;++c)a.push(E.selector.selection.getRangeAt(c));return a}return null},restoreSelection:function(a){if(a&&window.getSelection){E.selector.selection=window.getSelection();E.selector.selection.removeAllRanges();for(var c=0,b=a.length;c<b;++c)E.selector.selection.addRange(a[c])}}},makeEditable:function(a){$(E.currentEditableObj().trueOnly).each(function(){a?("click"==$(this).data("editable")?$(this).hasClass("editor-tolltip-on")||($(this).addClass("editor-tolltip-on"),
E.attachTooltip.to($(this))):$(this).attr("contenteditable","true"),E.active=!0):($(this).attr("contenteditable","false"),E.active=!1)})},resetEditor:{defaultFunc:function(a){E.makeEditable(!1);a||$("#editor-btn-start").fadeIn();$("#editor-btn-save, #editor-btn-exit, #editor-toolbox").fadeOut();E.attachTooltip.off();E.changeBtnsState($("img",".editor-tool"),"orig",!1);E.extend(this.services)},services:[]},markText:function(){var a=0;$(E.currentEditableObj().selectedOnly).each(function(c){c>E.editableLength/
2-1?($(this).data("edit",a+1),a++):$(this).data("edit",c+1)})},manualEditor:{init:function(){$("[contenteditable]").length&&!$("#editor-btn-start").length?E.createObjects("div","#editor",E.editBtns,"editor-btn-ignition"):$("#editor-btn-start").show();$(".editor-btn-ignition").click(function(){if("editor-btn-start"==$(this).attr("id"))E.makeEditable(!0),E.selector.selectionFor($("[contenteditable]:not([data-editable])")),$(this).fadeOut(),$("#editor-btn-save, #editor-btn-exit, #editor-toolbox").fadeIn(),
E.extend(E.manualEditor.services),E.pasteNoStyle($("[contenteditable]")),E.detectChange.run($("[contenteditable]")),$("[contenteditable]").keypress(function(a){if(13==a.which)return document.execCommand("insertHTML",!1,"<br><br>"),!1}),$("#editor").addClass("launched");else if("editor-btn-exit"==$(this).attr("id"))E.resetEditor.defaultFunc();else if("editor-btn-save"==$(this).attr("id")){E.resetEditor.defaultFunc();var a=""==E.settings.path?E.settings.src:E.settings.path+"/"+E.settings.src;$("#editor-htmlContent").empty().load(a,
function(a,b,d){"success"==b&&(E.markText(),E.saveToFile.init())})}});E.createToolbox();E.socket().on("savingStatus",function(a,c){"SUCCESS"==a?E.popupMessage(a.toLowerCase(),a,c,3E3):E.popupMessage(a.toLowerCase(),a,JSON.stringify(c),3E3)})},services:[]},pasteNoStyle:function(a){if(!E.wasHereActivated())a.on("paste",function(a){a.preventDefault();a=(a.originalEvent||a).clipboardData.getData("text/plain");window.document.execCommand("insertText",!1,a)})},saveToFile:{init:function(){var a=!1;E.extend(this.services);
$(E.currentEditableObj().selectedOnly).each(function(c){if(c>E.editableLength/2-1)return a?E.socket().emit("htmlData",$("#editor-htmlContent").html(),E.settings.path,E.settings.src):E.popupMessage("","STATUS","No content has been changed.",2500),!1;if($(this).html()!==$("#editor-htmlContent [contenteditable]").eq($(this).data("edit")-1).html()){E.debug.saving($(this));c=$("#editor-htmlContent [contenteditable]").eq($(this).data("edit")-1).html();var b=$(this).html();E.log.change(E.googleDiffExtend.compare(c,
b));a=!0;$("#editor-htmlContent [contenteditable]").eq($(this).data("edit")-1).html($(this).html())}})},services:[]},debug:{state:!1,saving:function(a){this.state&&(console.log(a.html()),console.log("edit: "+a.data("edit")),console.log($("#editor-htmlContent [contenteditable]").eq(a.data("edit")-1).html()))}},createToolbox:function(){E.createEditorObj("div")("#editor","editor-toolbox").load("editor/tool-box.html",function(){function a(){b.off("focusout");e.remove();E.selector.$editingObj.show();c();
E.changeBtnsState($("img",".editor-tool"),"active",!0);E.selector.restoreSelection(E.selector.savedSelection)}function c(){function a(){d.removeClass("active").find("input").val("")}E.isGS()?(TweenMax.to($("#editor-add-link, #editor-hide-link"),.3,{width:0,opacity:0,clearProps:"all"}),TweenMax.to(b,.3,{width:0,opacity:0,clearProps:"all",onComplete:a})):($("#editor-add-link, #editor-hide-link, #editor-link-input input").css({width:0}).attr("style",""),a())}$.ui&&$(this).draggable({handle:"#editor-toolbox-handle"},
{cursor:"move"},{containment:"body"});var b=$("#editor-link-input input"),d=$("#editor-link-input"),e="",g=$("#editor-add-link");$(".editor-tool").mousedown(function(c){$target=$(c.target).parent();if(!$target.hasClass("activated"))return!1;if("createLink"==$target.data("editor_action")){E.changeBtnsState($("img",".editor-tool"),"orig",!1);d.addClass("active");var h=E.selector.savedSelection[0].startContainer.textContent;c=[];for(var f=0;f<E.selector.$editingObj.contents().length;f++){var g=E.selector.$editingObj.contents()[f],
k="";g.textContent==h?(k=g.textContent,k=k.insert(E.selector.savedSelection[0].endOffset,"</span>"),k=k.insert(E.selector.savedSelection[0].startOffset,"<span id='editor-selection'>"),c.push(k)):c.push(g)}h="";for(f=0;f<c.length;f++)h=c[f].data?h+c[f].data:c[f].outerHTML?h+c[f].outerHTML:h+c[f];E.selector.$editingObj.hide().clone(!0,!0).addClass("editor-obj-duplicate").insertAfter(E.selector.$editingObj).show();e=$(".editor-obj-duplicate");e.html(h);setTimeout(function(){b.focus();b.on("focusout",
function(){a()})},0);E.isGS()?TweenMax.fromTo(b,.2,{width:0},{width:165}):b.css({width:165})}else"unlink"==$target.data("editor_action")&&(E.changeBtnsState($("img",".editor-tool"),"orig",!1),window.getSelection().removeAllRanges()),document.execCommand($target.data("editor_action"),!1,!0)});g.click(function(){var a=$(this).siblings("#editor-link-input input").val();if(E.isURL(a))e.remove(),E.selector.$editingObj.show(),E.selector.restoreSelection(E.selector.savedSelection),document.execCommand($(this).data("editor_action"),
!1,$(this).siblings("#editor-link-input input").val()),E.selectedText.editableObj.find("a").each(function(){$(this).attr("target")||$(this).attr("target","_blanc")});else return""==a?E.popupMessage("error","URL EMPTY","Please insert URL.",2500):E.popupMessage("error","URL ERROR","Not a valid URL format.<br/>Try again.",2500),b.focus(),!1;c();E.changeBtnsState($("img",".editor-tool:not('.editor-link-tool[data-editor-tag]')"),"orig",!1)});E.activateKey(b,13,function(){b.blur();g.focus().click()});$("#editor-hide-link").click(function(){a()})})},
changeBtnsState:function(a,c,b){a.each(function(){$(this).attr("src",$(this).data(c));b?$(this).parent().addClass("activated"):$(this).parent().removeClass("activated")})},attachTooltip:{to:function(a){a.hover(function(){if(E.active){var a=$(this),b=a.data("edit"),d=!1;$tooltip=$(".editor-tooltip");$tooltip.length&&$tooltip.each(function(){if($(this).data("obj")==b)return d=!0,!1});if(!d){$(this).parent().css("position","relative");var e=$(this).data("editable_html")?$(this).html():$(this).text(),
g=30>a.outerHeight()?40:a.outerHeight();$("<div></div>").appendTo($(this).parent()).addClass("editor-tooltip editor-tooltip"+b).data("obj",b).html(e).show().css({marginLeft:-$(this).parent().outerWidth()/2,top:-g,maxWidth:$(this).parent().outerWidth()}).attr("contenteditable",!0).append("<div class='editor-tooltip-exit' contenteditable='false'></div>");$("<div></div>").appendTo(".editor-tooltip"+b).addClass("editor-tooltip-arrow editor-tooltip-arrow"+b).show().css({left:$(".editor-tooltip"+b).outerWidth()/
2-$(".editor-tooltip-arrow").outerWidth()/2,top:$(".editor-tooltip"+b).outerHeight()});E.isGS()?TweenMax.from($(".editor-tooltip"+b),.5,{y:50,scale:0,opacity:0}):$(".editor-tooltip"+b).show();E.selector.selectionFor($(".editor-tooltip"+b),a.data("editable"));E.detectChange.run($(".editor-tooltip"+b+"[contenteditable]"));$(".editor-tooltip-exit").click(function(a){a.stopPropagation();$(".editor-tooltip-arrow"+$(this).parent().data("obj")).remove();$(this).parent().remove()});E.pasteNoStyle($(".editor-tooltip"+
b))}}})},off:function(){$(".editor-tooltip, .editor-tooltip-arrow").remove();$(".editor-tolltip-on").removeClass("editor-tolltip-on")}},detectChange:{run:function(a,c){var b="",d="";E.location.allow()||this.preventBubble(a);a.on("focus",function(){b=$(this).html()}).on("blur keyup paste",function(){b==$(this).html()&&b.substring(0,d.length)==d||$(this).trigger("change")});a.on("change",function(){b=$(this).html();$(this).data("obj")?(d=$(this).html().substring(0,$(this).html().indexOf('<div class="editor-tooltip-exit" contenteditable="false">')),
$(this).data("obj")==$("[contenteditable]:data('edit')").eq($(this).data("obj")-1).data("edit")&&$("[contenteditable]:data('edit')").eq($(this).data("obj")-1).html(d)):E.extend(E.detectChange.conditions,$(this))})},preventBubble:function(a){a.on("click",function(a){a.stopPropagation()})},conditions:[]},location:{allow:function(){for(var a=0;a<this.conditions.length;a++)if(this.conditions[a]()){var c=this.conditions[a]();break}return c},conditions:[]},currentEditableObj:function(){for(var a="[contenteditable]",
c="[contenteditable]",b=0;b<E.excludeObj.length;b++)for(var d=0;d<E.excludeObj[b].length;d++)if("string"==typeof E.excludeObj[b][d]){var e=":not('"+E.excludeObj[b][d]+"')";1==E.excludeObj[b][d+1]&&(e=":not('"+E.excludeObj[b][d]+"')",c+=e);a+=e}return $editableObj={selectedOnly:$(a),trueOnly:$(c)}},extend:function(a,c){if(a)for(var b=0;b<a.length;b++)if(a[b])a[b](c)},activateKey:function(a,c,b){a.keypress(function(a){a.which==c&&b()})},popupMessage:function(a,c,b,d){$("#editor-message").length||E.createEditorObj("div")("#editor",
"editor-message");$("#editor-message").addClass(a).text(c).append("<p>"+b+"</p>").fadeIn();d&&$("#editor-message").delay(d).fadeOut()},createEditorObj:function(a){return function(c,b,d){"img"==a?$("<img>").appendTo(c).attr("id",b).addClass(d):"input"==a?$("<input>").appendTo(c).attr({id:b,placeholder:"John Smith"}).addClass(d):"div"==a&&$("<div></div>").appendTo(c).attr("id",b).addClass(d);return $("#"+b)}},createObjects:function(a,c,b,d){for(var e=0;e<b.length;e++)E.createEditorObj(a)(c,b[e],d)},
isObjEmpty:function(a){for(var c in a)if(a.hasOwnProperty(c))return!1;return!0},isURL:function(a){var c=RegExp("^(?!mailto:)(?:(?:http|https|ftp)://)(?:\\S+(?::\\S*)?@)?(?:(?:(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[0-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z\\u00a1-\\uffff0-9]+-?)*[a-z\\u00a1-\\uffff0-9]+)(?:\\.(?:[a-z\\u00a1-\\uffff0-9]+-?)*[a-z\\u00a1-\\uffff0-9]+)*(?:\\.(?:[a-z\\u00a1-\\uffff]{2,})))|localhost)(?::\\d{2,5})?(?:(/|\\?|#)[^\\s]*)?$",
"i");return 2083>a.length&&c.test(a)},isGS:function(){if(TweenMax||TweenLite)return!0}};String.prototype.insert=function(a,c){return 0<a?this.substring(0,a)+c+this.substring(a,this.length):c+this};
E.googleDiffExtend={prittierHTML:function(){diff_match_patch.prototype.diff_prettierHtml=function(a){for(var c=[],b=0;b<a.length;b++){var d=a[b][1];switch(a[b][0]){case DIFF_INSERT:c[b]='<ins style="background:#e6ffe6;">'+d+"</ins>";break;case DIFF_DELETE:c[b]='<del style="background:#ffe6e6;">'+d+"</del>";break;case DIFF_EQUAL:c[b]="<span>"+d+"</span>"}}return c.join("")}},compare:function(a,c){var b=E.googleDiff.diff_main(a,c);E.googleDiff.diff_cleanupSemantic(b);return E.googleDiff.diff_prettierHtml(b)}};