/**
Browser Editor v1.0, Plugin that allows editing html file in the browser.
Copyright (C) 2015,  Marcin Banaszak, http://www.marcinbanaszak.com,
https://github.com/lajon9/browser-editor

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish copies of the Software, and to permit 
persons to whom the Software is furnished to do so, subject to the following 
conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
IN NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR
OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
OTHER DEALINGS IN THE SOFTWARE.
**/

var E={init:!1,active:!1,wasHereActivated:function(){return $("#editor").hasClass("launched")?!0:!1},selectedText:{},editableLength:0,excludeObj:[],editBtns:["editor-btn-start","editor-btn-save","editor-btn-exit"],imagesObjects:["editor-images-handle","editor-images-desc","editor-images-wrapper"],on:function(){return"/"==window.location.pathname&&"9000"==window.location.port?!0:!1},socket:function(){return socket=io.connect("http://localhost:9000")},edit:function(a){E.on()&&(E.init?E.activate.init(a):
($("<link/>",{rel:"stylesheet",type:"text/css",href:"editor/content-editor.css"}).appendTo("head"),$.getScript("socket.io/socket.io.js").done(function(b,c){E.activate.init(a)}).fail(function(a,c,d){E.popupMessage("error","SCRIPT ERROR","Triggered ajaxError handler.",2500)})))},activate:{init:function(a){E.selectedText&&(E.selectedText={});E.init&&E.resetEditor.defaultFunc();!$("[contenteditable]").length&&$("#editor-btn-start").length?$(".editor-btn-ignition").hide():($("#editor-htmlContent").length||
($("body").css("position","relative"),E.createEditorObj("body","editor"),E.createEditorObj("#editor","editor-htmlContent").hide()),$("#editor-htmlContent").empty().load(a,function(a,c,d){"success"==c&&($("#editor").removeClass("launched"),E.editableLength=$(E.currentEditableObj().selectedOnly).length,E.markText(),E.init||(E.manualEditor.init(),E.init=!0),E.extend(E.activate.services))}))},services:[]},selector:{savedSelection:{},selection:{},$editingObj:{},selectionFor:function(a,b){a.length&&(b?
E.selector.getSelectionObject(a,b):E.isObjEmpty(E.selectedText)&&E.selector.getSelectionObject(a))},getSelectionObject:function(a,b){a.mousedown(function(){window.getSelection().removeAllRanges()});a.mouseup(function(){if(E.active){var a=E,d;d=window.getSelection?{selectedObj:window.getSelection(),selectedString:window.getSelection().toString()}:void 0;a.selectedText=d;E.selectedText.editableString=$(this).html();E.selectedText.editableObj=$(this);E.selector.savedSelection=E.selector.saveSelection();
E.selector.$editingObj=$(E.selector.saveSelection()[0].startContainer.parentNode);E.selectedText.selectedString?b?E.selector.determineSelection($("img",".editor-tool:not('.editor-link-tool')")):E.selector.determineSelection($("img",".editor-tool")):E.changeBtnsState($("img",".editor-tool"),"orig",!1)}})},determineSelection:function(a){E.changeBtnsState(a,"orig",!1);for(var b=0;b<E.selector.$editingObj.contents().length;b++){var c=E.selector.$editingObj.contents()[b],d=E.selector.$editingObj.contents().context.localName,
e=E.selector.$editingObj.contents().context.innerText;if(-1!=c.textContent.indexOf(E.selectedText.selectedString)){"b"===d||"i"===d||"u"===d?e===E.selectedText.selectedString&&E.changeBtnsState(a,"active",!0):"a"===d?e===E.selectedText.selectedString&&E.changeBtnsState($("img",a.parent("[data-editor-tag='a']")),"active",!0):E.changeBtnsState(a,"active",!0);break}}},saveSelection:function(){if(window.getSelection&&(E.selector.selection=window.getSelection(),E.selector.selection.getRangeAt&&E.selector.selection.rangeCount)){for(var a=
[],b=0,c=E.selector.selection.rangeCount;b<c;++b)a.push(E.selector.selection.getRangeAt(b));return a}return null},restoreSelection:function(a){if(a&&window.getSelection){E.selector.selection=window.getSelection();E.selector.selection.removeAllRanges();for(var b=0,c=a.length;b<c;++b)E.selector.selection.addRange(a[b])}}},makeEditable:function(a){$(E.currentEditableObj().trueOnly).each(function(){a?("click"==$(this).data("editable")?$(this).hasClass("editor-tolltip-on")||($(this).addClass("editor-tolltip-on"),
E.attachTooltip($(this))):$(this).attr("contenteditable","true"),E.active=!0):($(this).attr("contenteditable","false"),E.active=!1)})},resetEditor:{defaultFunc:function(a){E.makeEditable(!1);a||$("#editor-btn-start").fadeIn();$("#editor-btn-save, #editor-btn-exit, #editor-toolbox").fadeOut();E.clearTooltips();E.changeBtnsState($("img",".editor-tool"),"orig",!1);E.extend(this.services)},services:[]},markText:function(){var a=0;$(E.currentEditableObj().selectedOnly).each(function(b){b>E.editableLength/
2-1?($(this).data("edit",a+1),a++):$(this).data("edit",b+1)})},manualEditor:{init:function(){$("[contenteditable]").length&&!$("#editor-btn-start").length?E.createObjects("#editor",E.editBtns,"editor-btn-ignition"):$("#editor-btn-start").show();$(".editor-btn-ignition").click(function(){if("editor-btn-start"==$(this).attr("id"))E.makeEditable(!0),E.selector.selectionFor($("[contenteditable]:not([data-editable])")),$(this).fadeOut(),$("#editor-btn-save, #editor-btn-exit, #editor-toolbox").fadeIn(),
E.extend(E.manualEditor.services),E.pasteNoStyle($("[contenteditable]")),E.detectChange.run($("[contenteditable]")),$("[contenteditable]").keypress(function(a){if(13==a.which)return document.execCommand("insertHTML",!1,"<br><br>"),!1}),$("#editor").addClass("launched");else if("editor-btn-exit"==$(this).attr("id"))E.resetEditor.defaultFunc();else if("editor-btn-save"==$(this).attr("id")){E.resetEditor.defaultFunc();var a=""==E.settings.path?E.settings.src:E.settings.path+"/"+E.settings.src;$("#editor-htmlContent").empty().load(a,
function(a,c,d){"success"==c&&(E.markText(),E.saveToFile())})}});E.createToolbox();E.socket().on("savingStatus",function(a,b){"SUCCESS"==a?E.popupMessage(a.toLowerCase(),a,b,3E3):E.popupMessage(a.toLowerCase(),a,JSON.stringify(b),3E3)});E.activateKey($(document),69,function(){"none"==$("#editor-btn-start").css("display")&&"none"==$("#editor-btn-save, #editor-btn-exit").css("display")?$("#editor-btn-start").show():($(".editor-btn-ignition, #editor-toolbox").hide(),E.resetEditor.defaultFunc(!0),window.getSelection().removeAllRanges())})},
services:[]},pasteNoStyle:function(a){if(!E.wasHereActivated())a.on("paste",function(a){a.preventDefault();a=(a.originalEvent||a).clipboardData.getData("text/plain");window.document.execCommand("insertText",!1,a)})},saveToFile:function(){var a=!1;$(E.currentEditableObj().selectedOnly).each(function(b){if(b>E.editableLength/2-1)return a?E.socket().emit("htmlData",$("#editor-htmlContent").html(),E.settings.path,E.settings.src):E.popupMessage("","STATUS","No content has been changed.",2500),!1;$(this).html()!==
$("#editor-htmlContent [contenteditable]").eq($(this).data("edit")-1).html()&&(a=!0,$("#editor-htmlContent [contenteditable]").eq($(this).data("edit")-1).html($(this).html()))})},debug:function(a){console.log(a.html());console.log($("#editor-htmlContent [contenteditable]").eq(a.data("edit")-1).html())},createToolbox:function(){E.createEditorObj("#editor","editor-toolbox").load("editor/tool-box.html",function(){function a(){c.off("focusout");e.remove();E.selector.$editingObj.show();b();E.changeBtnsState($("img",
".editor-tool"),"active",!0);E.selector.restoreSelection(E.selector.savedSelection)}function b(){function a(){d.removeClass("active").find("input").val("")}E.isGS()?(TweenMax.to($("#editor-add-link, #editor-hide-link"),.3,{width:0,opacity:0,clearProps:"all"}),TweenMax.to(c,.3,{width:0,opacity:0,clearProps:"all",onComplete:a})):($("#editor-add-link, #editor-hide-link, #editor-link-input input").css({width:0}).attr("style",""),a())}$.ui&&$(this).draggable({handle:"#editor-toolbox-handle"},{cursor:"move"},
{containment:"body"});var c=$("#editor-link-input input"),d=$("#editor-link-input"),e="",g=$("#editor-add-link");$(".editor-tool").mousedown(function(b){$target=$(b.target).parent();if(!$target.hasClass("activated"))return!1;if("createLink"==$target.data("editor_action")){E.changeBtnsState($("img",".editor-tool"),"orig",!1);d.addClass("active");var h=E.selector.savedSelection[0].startContainer.textContent;b=[];for(var f=0;f<E.selector.$editingObj.contents().length;f++){var g=E.selector.$editingObj.contents()[f],
k="";g.textContent==h?(k=g.textContent,k=k.insert(E.selector.savedSelection[0].endOffset,"</span>"),k=k.insert(E.selector.savedSelection[0].startOffset,"<span id='editor-selection'>"),b.push(k)):b.push(g)}h="";for(f=0;f<b.length;f++)h=b[f].data?h+b[f].data:b[f].outerHTML?h+b[f].outerHTML:h+b[f];E.selector.$editingObj.hide().clone(!0,!0).addClass("editor-obj-duplicate").insertAfter(E.selector.$editingObj).show();e=$(".editor-obj-duplicate");e.html(h);setTimeout(function(){c.focus();c.on("focusout",
function(){a()})},0);E.isGS()?TweenMax.fromTo(c,.2,{width:0},{width:165}):c.css({width:165})}else"unlink"==$target.data("editor_action")&&(E.changeBtnsState($("img",".editor-tool"),"orig",!1),window.getSelection().removeAllRanges()),document.execCommand($target.data("editor_action"),!1,!0)});g.click(function(){var a=$(this).siblings("#editor-link-input input").val();if(E.isURL(a))e.remove(),E.selector.$editingObj.show(),E.selector.restoreSelection(E.selector.savedSelection),document.execCommand($(this).data("editor_action"),
!1,$(this).siblings("#editor-link-input input").val()),E.selectedText.editableObj.find("a").each(function(){$(this).attr("target")||$(this).attr("target","_blanc")});else return""==a?E.popupMessage("error","URL EMPTY","Please insert URL.",2500):E.popupMessage("error","URL ERROR","Not a valid URL format.<br/>Try again.",2500),c.focus(),!1;b();E.changeBtnsState($("img",".editor-tool:not('.editor-link-tool[data-editor-tag]')"),"orig",!1)});E.activateKey(c,13,function(){c.blur();g.focus().click()});$("#editor-hide-link").click(function(){a()})})},
changeBtnsState:function(a,b,c){a.each(function(){$(this).attr("src",$(this).data(b));c?$(this).parent().addClass("activated"):$(this).parent().removeClass("activated")})},attachTooltip:function(a){a.hover(function(){if(E.active){var a=$(this),c=a.data("edit"),d=!1;$tooltip=$(".editor-tooltip");$tooltip.length&&$tooltip.each(function(){if($(this).data("obj")==c)return d=!0,!1});if(!d){$(this).parent().css("position","relative");var e=$(this).data("editable_html")?$(this).html():$(this).text(),g=30>
a.outerHeight()?40:a.outerHeight();$("<div></div>").appendTo($(this).parent()).addClass("editor-tooltip editor-tooltip"+c).data("obj",c).html(e).show().css({marginLeft:-$(this).parent().outerWidth()/2,top:-g,maxWidth:$(this).parent().outerWidth()}).attr("contenteditable",!0).append("<div class='editor-tooltip-exit' contenteditable='false'></div>");$("<div></div>").appendTo(".editor-tooltip"+c).addClass("editor-tooltip-arrow editor-tooltip-arrow"+c).show().css({left:$(".editor-tooltip"+c).outerWidth()/
2-$(".editor-tooltip-arrow").outerWidth()/2,top:$(".editor-tooltip"+c).outerHeight()});E.isGS()?TweenMax.from($(".editor-tooltip"+c),.5,{y:50,scale:0,opacity:0}):$(".editor-tooltip"+c).show();E.selector.selectionFor($(".editor-tooltip"+c),a.data("editable"));E.detectChange.run($(".editor-tooltip"+c+"[contenteditable]"));$(".editor-tooltip-exit").click(function(a){a.stopPropagation();$(".editor-tooltip-arrow"+$(this).parent().data("obj")).remove();$(this).parent().remove()});E.pasteNoStyle($(".editor-tooltip"+
c))}}})},clearTooltips:function(){$(".editor-tooltip, .editor-tooltip-arrow").remove();$(".editor-tolltip-on").removeClass("editor-tolltip-on")},detectChange:{run:function(a,b){var c="",d="";E.location.allow()||this.preventBubble(a);a.on("focus",function(){c=$(this).html()}).on("blur keyup paste",function(){c==$(this).html()&&c.substring(0,d.length)==d||$(this).trigger("change")});a.on("change",function(){c=$(this).html();$(this).data("obj")?(d=$(this).html().substring(0,$(this).html().indexOf('<div class="editor-tooltip-exit" contenteditable="false">')),
$(this).data("obj")==$("[contenteditable]:data('edit')").eq($(this).data("obj")-1).data("edit")&&$("[contenteditable]:data('edit')").eq($(this).data("obj")-1).html(d)):E.extend(E.detectChange.conditions,$(this))})},preventBubble:function(a){a.on("click",function(a){a.stopPropagation()})},conditions:[]},location:{allow:function(){for(var a=0;a<this.conditions.length;a++)if(this.conditions[a]()){var b=this.conditions[a]();break}return b},conditions:[]},currentEditableObj:function(){for(var a="[contenteditable]",
b="[contenteditable]",c=0;c<E.excludeObj.length;c++)for(var d=0;d<E.excludeObj[c].length;d++)if("string"==typeof E.excludeObj[c][d]){var e=":not('"+E.excludeObj[c][d]+"')";1==E.excludeObj[c][d+1]&&(e=":not('"+E.excludeObj[c][d]+"')",b+=e);e=":not('"+E.excludeObj[c][d]+"')";a+=e}return $editableObj={selectedOnly:$(a),trueOnly:$(b)}},extend:function(a,b){if(a)for(var c=0;c<a.length;c++)if(a[c])a[c](b)},activateKey:function(a,b,c){a.keypress(function(a){a.which==b&&c()})},popupMessage:function(a,b,c,
d){$("#editor-message").length||E.createEditorObj("#editor","editor-message");$("#editor-message").addClass(a).text(b).append("<p>"+c+"</p>").fadeIn().delay(d).fadeOut()},createEditorObj:function(a,b,c,d){d?$("<img>").appendTo(a).attr("id",b).addClass(c):$("<div></div>").appendTo(a).attr("id",b).addClass(c);return $("#"+b)},createObjects:function(a,b,c){for(var d=0;d<b.length;d++)E.createEditorObj(a,b[d],c)},isObjEmpty:function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},isURL:function(a){var b=
RegExp("^(?!mailto:)(?:(?:http|https|ftp)://)(?:\\S+(?::\\S*)?@)?(?:(?:(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[0-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z\\u00a1-\\uffff0-9]+-?)*[a-z\\u00a1-\\uffff0-9]+)(?:\\.(?:[a-z\\u00a1-\\uffff0-9]+-?)*[a-z\\u00a1-\\uffff0-9]+)*(?:\\.(?:[a-z\\u00a1-\\uffff]{2,})))|localhost)(?::\\d{2,5})?(?:(/|\\?|#)[^\\s]*)?$","i");return 2083>a.length&&b.test(a)},isGS:function(){if(TweenMax||TweenLite)return!0}};
String.prototype.insert=function(a,b){return 0<a?this.substring(0,a)+b+this.substring(a,this.length):b+this};